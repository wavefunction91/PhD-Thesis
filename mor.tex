\chapter{Molecular Response Properties Through Model Order Reduction}


The previous sections have developed the formal theory to practically obtain the stationary 
(\cref{eq:TIQWave}) electronic ground and excited states of molecular systems.
While such developments provide the basis of any practical quantum theory, the majority of interesting chemical
phenomena result for the departure from the a stationary state through the action of some external perturbation,
i.e. light. In this chapter we will focus on the interaction and response of molecular systems with external 
electromagnetic fields which will allow us to probe many physically observable quantities such as
the photoabsorption cross section. The following sections have been adapted and reproduced in part with
permission from Roel van Beeumen, David B. Williams-Young, Joeseph M. Kasper, Chao Yang, Esmond G. Ng,
and Xiaosong Li. Model Order Reduction Algorithm for Estimating the Absorption Spectrum. 
\emph{J. Chem. Theory Comput.} \textbf{2017}, 13(10), pp 4950-4961. Copyright 2017 American Chemical
Society.


% Semi--Classical Light Matter
\section{Semi--Classical Light--Matter Interaction}
\label{sec:SCLMI}

In this section, we will provide a brief overview of the non-relativistic treatment of
light--matter interaction for molecular systems. As such, we will not be concerned with
the nature of retartation effects of transverse photons nor the quantized nature of
the photon itself; hence this is referred to as a semi-classical treatment of light-matter
interation. This will allow us to treat this interaction solely as the interaction of
the molecular system with an external, time--dependent, classical electromagnetic field. 

\subsection{Classical Electromagnetic Fields}

Classically, the mechanics of electromagentic fields is governed by Maxwell's equations
\todo{cite JAckson Barron}. In the absense of charge sources, Maxwell's equations are given in differential
form and SI (or atomic) units by,
\begin{subequations}
\label{eq:MaxwellEB}
\begin{alignat}{1}
&\nabla \cdot \vc E(\vc{r},t) = 0, \\
&\nabla \cdot \vc B(\vc r,t) = 0, \\
&\nabla \times \vc E(\vc r,t ) = -\partial_t \vc {B}(\vc r,t ),\\
&\nabla \times \vc B(\vc r,t ) = \frac{1}{c^2}\partial_t \vc {E}(\vc r,t ),
\end{alignat}
\end{subequations}
where $\vc E$ and $\vc B$ are the classical vector fields which describe the electric and
magnetic compoenents of the electromagnetic field, respectively. The top two equations
of \cref{eq:MaxwellEB} describe the divergence of the $\vc E$ and $\vc B$ fields, while
the latter two describe the curl, where '$\times$' denotes the cross produce. In the description of
the interactions of these fields with matter, it is useful to define a set of auxilary variables
\todo{cite Jackson Barron} ,
\begin{subequations}
\label{eq:SVPot}
\begin{align}
  \vc B(\vc r, t)  &= \nabla \times \vc A(\vc r, t),\\
  \vc E(\vc r, t)  &= -\nabla U(\vc r, t) - \partial_t \vc A(\vc r, t),
\end{align}
\end{subequations}
where $U$ and $\vc A$ are the so-called scalar and vector potentials, respectively. Using
the definitions in \cref{eq:SVPot}, \cref{eq:MaxwellEB} becomes a set to two homogenous 
differential equations
\begin{subequations}
\label{eq:MaxwellSV}
\begin{align}
&\Delta U(\vc r,t ) - \partial_t (\nabla \cdot \vc A(\vc r,t )) = 0\\
& \Delta A_\xi(\vc r, t) - \frac{1}{c^2} \partial^2_t A_\xi(\vc r,t) - \nabla_\xi \left( \nabla \cdot \vc A(\vc{r},t) + \frac{1}{c^2}\partial_t U(\vc r,t)\right)
 = 0, \quad \xi \in \{x,y,z\}.
\end{align}
\end{subequations}
The remarkable thing about the use of $U$ and $\vc A$ is that, due to \cref{eq:SVPot}, the  physical $\vc E$ and $\vc B$ fields
which they represent are invariant under linear gauge transformation \todo{cite Jackson Barron},
\begin{subequations}
\label{eq:GaugeFix}
\begin{align}
  \vc A(\vc r, t) &\mapsto \vc A'(\vc r, t) = \vc A(\vc r,t) + \nabla \chi(\vc r, t), \\ 
  U(\vc r,t) &\mapsto U'(\vc r, t) = U(\vc r, t) - \partial_t \chi(\vc r, t),
\end{align}
\end{subequations}
where $\chi(\vc r,t)$ is an arbitrary differentiable, real valued function, refered to as a gauge function.
The pair $(\vc A', U')$ yield the same $\vc E$ and $\vc B$ fields as $(\vc A, U)$ under \cref{eq:SVPot},
thus the physical singificance of \cref{eq:MaxwellSV} is invariant under this transformation.

Of particular interest to this work are the monochromatic planewave solutions to \cref{eq:MaxwellEB,eq:MaxwellSV}
which take on the form \todo{cite}
\begin{subequations}
\begin{align}
\vc E(\vc r, t) = \vc E_0 e^{\ii\vc k \cdot \vc r} e^{-\ii\omega t}\\
\vc B(\vc r, t) = \vc B_0 e^{\ii\vc k \cdot \vc r} e^{-\ii\omega t}
\end{align}
\end{subequations}
where $\vc k$ is the wave vector determining the direction of propagation, and $\omega = c\vert\vc k\vert$ is the
angular frequency. $\vc E_0$ and $\vc B_0$ are the amplitudes of the $\vc E$ and $\vc B$ fields respectively.
By \cref{eq:GaugeFix}, we may always choose a gauge such that $U(\vc r,t) = 0$ for planewaves. 
This gauge choice is known as the Weyl gauge \todo{cite}. As such, the vector potential (\cref{eq:SVPot}) becomes \todo{confirm}
\begin{equation}
\vc A(\vc r, t) = -\int_0^t \vc E(\vc r, t') \dd t' = -\frac{1}{\omega} \vc E'_0 e^{\ii\vc k \cdot \vc r} e^{-\ii\omega t}.
\end{equation}
where $\vc E'_0 = \ii \vc E_0$. 
In the limit of molecular length dimensions, for reasonably low frequency light it is reasonable to assume
\begin{equation}
\vc k \cdot \vc r \approx 0.
\end{equation}
That is to say that the wave length of the oscillating field is much larger than the molecule it  self, thus
from the molecular perspective, it is experiencing a uniformly distrubuted field despite the global topology of
the physical wave front. This approximation is known as the electric dipole approximation (EDA), and will be used
throughout the work. Within the EDA, the spatial portion of the wave front is truncated in a Taylor series,
\begin{equation}
e^{\ii\vc k \cdot \vc r} = 1 + \sum_{n=1}^\infty \frac{(\ii \vc k \cdot \vc r)^n}{n!} \approx 1.
\end{equation}
Thus the vector potential becomes
\begin{equation}
\label{eq:EDAV}
\vc A(\vc r, t) \approx \vc A_\mathrm{EDA}(t) = -\frac{1}{\omega} \vc E'_0 e^{-\ii\omega t}.
\end{equation}
As such, the magnetic field vanishes within the EDA,
\begin{equation}
\vc B(\vc r, t) \approx 0, \qquad \text{EDA}.
\end{equation}


\subsection{Non--Relativistic Molecular Hamiltonian in the Presence of Fields}

In the presence of an electromagnetic field described $(\vc A,U)$, the
Born--Oppenhemier Hamiltonian (\cref{eq:NRBOH}) for a system with $N$ electrons
becomes
\begin{equation}
\op H^\mathrm{BO}_{el} \mapsto \op H_{el}(t) = 
  \frac{1}{2} \sum_{i=1}^N \left( \op{\vc p}(i) + \op{\vc A}(i \prm t) \right)^2 - 
  \op V_{ne}(i) - \op U(i \prm t) + \frac{1}{2}\sum_{i\neq j = 1}^N \op g^C(i,j),
\end{equation}
where the operators $\op U$ and $\op {\vc A}$ are scalar (in the sense of density scalar,
i.e. void of spin dependence) multiplicitive operators which represent the external field.
That is to say
\begin{equation}
\op{A}_\xi(\vc r \prm t )\, \phi(\vc x\prm t )  = \phi(\vc x\prm t ) \,A_\xi(\vc r, t) , \quad \op{U}(\vc r \prm t) \,\phi(\vc x\prm t ) = \phi(\vc x\prm t ) \,U(\vc r, t)
\end{equation}
with $\ket{\phi (t)} \in \hilb H^1$.
As a vector, $\vc A$ and $\op{\vc A}$ both carry Cartesian indicies $\xi\in \{x,y,z\}$, the same as
$\op{\vc{p}}$.
Time dependence has been noted by $t$ following a $\vert$ to separate out time and particle
dependence.  Expanding the square, we obtain
\begin{equation}
\op H_{el}(t) = \op H^\mathrm{BO}_{el} + \op V_{ext}(t)
\end{equation}
where
\begin{align}
\op V_{ext}(t) &= \sum_{i=1}^N \op{\vc p}(i) \cdot \op{\vc A}(i \prm t) + \op{\vc A}(i \prm t) \cdot \op{\vc p}(i) + \op{A}^2(i \, \vert \, t) - 
  U(i \prm t) \nonumber \\
  &\approx \sum_{i=1}^N  \op{\vc A}(i \prm t) \cdot \op{\vc p}(i) - U(i \prm t). \label{eq:CouGaugeOp}
\end{align}
The approximation in \Cref{eq:CouGaugeOp} has introduced two concepts implicitly. The first being the removal of the term 
$\op{\vc p} \cdot \op{\vc A}$, which has been achieved by enforcing $\nabla \cdot \vc A = 0$. This choice is referred
to as the Coulomb gauge, and is always possible through the proper choice of gauge function (\cref{eq:GaugeFix}). The
actual approximation in \cref{eq:CouGaugeOp} is in the neglection of the $A^2$ term. In the weak field strength limit,
the $A^2$ is quadratic in the field strength, while $\op{\vc A} \cdot \op{\vc p}$ is linear. In this limit, we may 
approximation $A^2 \approx 0$, thus this approximation is referred to as the weak field approximation.
Inserting in the expression for the vector potential in the EDA (\cref{eq:EDAV}) and invoking the Weyl gauge, 
we obtain
\begin{equation}
\label{eq:VextVel}
\op V_{ext}(t) \approx -\sum_{i=1}^N \frac{e^{-i\omega t}}{\omega} ( \vc E'_0 \cdot \op{\vc p}(i) ).
\end{equation}

The extraneous factor of $\omega$ may be removed by another gauge transformation, $\chi(\vc r,t) = -\vc r \cdot \vc A_\mathrm{EDA}$,
such that
\begin{align}
  \vc A_\mathrm{EDA}(\vc r, t) &\mapsto \vc A_\mathrm{EDA}(\vc r, t) - \nabla (\vc r \cdot \vc A_\mathrm{EDA}(\vc r,t))  = 0, \\
  U_\mathrm{EDA}(\vc r,t)  &\mapsto \vc r \cdot \partial_t \vc A_\mathrm{EDA}(\vc r,t) = -\ii e^{-i \omega t} (\vc E'_0 \cdot \vc r) =  e^{-i \omega t}(\vc E_0 \cdot \vc r).
\end{align}
which transforms \cref{eq:VextVel} to
\begin{equation}
\label{eq:VextLen}
\op V_{ext}(t) \approx -\sum_{i=1}^N e^{-i\omega t} ( \vc E_0 \cdot \op{\vc r}(i) ),
\end{equation}
where $\op{\vc r}$ is the position operator.

% Polarization Propagator
\subsection{Molecular Response and the Polarization Propagator}
\label{sec:PolarProp}

In this section we examine the response of a molecular system subject to an external, time dependent perturbation, $\op V_{ext}(t)$.

% Absorption Cross Section
\subsection{The Linear Absorption Cross Section}
\label{sec:AbsorptionTheory}

\section{Interpolatory Model Order Reduction of Linear Dynamical Systems}
\label{lds:dyn-sys}

In this section, we briefly review the theory of model order reduction for
linear dynamical systems. The next section will examine its connection to the
computation of the absorption spectrum within the FOPPA.

% --- Linear dynamical systems --- %
\subsection{Linear dynamical systems}
\label{lds:mimo}

We consider the linear multiple-input multiple-output (MIMO) system
\begin{equation}
  \bSigma = \left\{\begin{aligned}
    \left( \bH - s\bS \right) \bfx(s) &= \bfb\,u(s) \\
                              \bfy(s) &= \bfc\T \bfx(s)
  \end{aligned}\right.,
  \label{eq:siso}
\end{equation}
where $s$ is a derivative or shift operator, $\bH \inRR{n}$ and $\bS \inRR{n}$ are the system matrices, $\bfb \inR[n][m]$, and $\bfc \inR[n][p]$. We call $n$ the dimension  (order) of the system $\bSigma$, $\bfx \inR[n][m]$ the state vector, $u \inR$ the input, and $\bfy \inR[p][m]$ the output \cite{Antoulas2005}. Note that the system $\bSigma$ is completely characterized by the quadruple $(\bH,\bS,\bfb,\bfc)$.

The transfer function, $\bfvarpi(s)$, of $\bSigma$ is defined as
\begin{equation}
  \bfvarpi(s) = \bfc\T \left( \bH - s\bS \right)\inv \bfb,
  \label{eq:siso-tf}
\end{equation}
and describes the relation between the input and output of $\bSigma$, i.e., $\bfy(s) = \bfvarpi(s) u(s)$. For the remainder, we will assume that $n \gg 1$, $m \ll n$, $p \ll n$, and $u(s) \equiv 1$ for all $s$.

% --- State space transformation --- %
\subsection{State space transformation}
\label{lds:ss-transf}

In some cases, it might be more advantageous to describe the system from a different point of view as the original one. In these cases, we may perform a non-singular state transformation $\bT$, i.e., $\det(\bT) \neq 0$, yielding the transformed state
\begin{equation}
  \bfxt = \bT\inv \bfx,
  \label{eq:defxtil}
\end{equation}
of the transformed system
\begin{equation}
  \bSigmat = \left\{\begin{aligned}
    \left( \bHt - s\bSt \right) \bfxt(s) &= \bfbt\,u(s) \\
                                 \bfy(s) &= \bfct\T \bfxt(s)
  \end{aligned}\right.,
\end{equation}
where $\bHt = \bT\inv \bH \bT$, $\bSt = \bT\inv \bS \bT$, $\bfbt = \bT\inv \bfb$, and $\bfct\T = \bfc\T \bT$. Remark that $\bSigma$ and $\bSigmat$ admit the same transfer function as well as the same output. Therefore, we call the systems $\bSigma$ and $\bSigmat$ equivalent.

% --- Reduced order models --- %
\subsection{Reduced order models}
\label{lds:mor}

The evaluation of the transfer function of a system $\bSigma$ requires a linear system solve for every value of $s$. In cases where the system dimension $n$ is large and a high resolution is required, i.e., a high number of values of $s$, the evaluation of the transfer function is very expensive. In this work, we examine the effectiveness of model order reduction (MOR) techniques to circumvent this expense. MOR for linear dynamical systems is a technique that approximates a system $\bSigma$ by another system $\bSigmah$ of the same form but of a much lower dimension (order) $k \ll n$. Consequently, evaluating the transfer function of $\bSigmah$ is relatively inexpensive as it only involves linear system solves of dimension $k$ instead of linear system solves of dimension $n$ for $\bSigma$.

Let the system $\bSigma$ be given by \eqref{eq:siso} and define a non-singular matrix $\bV \inR[n][k]$ with orthonormal columns, i.e., $\bV\T \bV = \bI$. Then, a reduced order model $\bSigmah$ can be constructed by applying a Galerkin projection $\bP = \bV\bV\T$ onto $\bSigma$, yielding
\begin{equation}
  \bSigmah = \left\{\begin{aligned}
    \left( \bHh - s\bSh \right) \bfxh(s) &= \bfbh\,u(s) \\
                                \bfyh(s) &= \bfch\T \bfxh(s)
  \end{aligned}\right.,
\end{equation}
where $\bHh = \bV\T \bH \bV$, $\bSh = \bV\T \bS \bV$, $\bfbh = \bV\T \bfb$, and $\bfch\T = \bfc\T \bV$. Note that the length of the state vector $\bfxh$ and the dimension of $\bSigmah$ are only $k \ll n$. The purpose of MOR is to construct a $\bV$ such that the transfer function of $\bSigmah$ approximates very well the one of $\bSigma$,
\begin{equation}
  \bfvarpi_\bSigma(s) \approx \bfvarpi_{\bSigmah}(s),
  \label{eq:tf-match}
\end{equation}
for all query $s$.

% --- Model order reduction via moment matching --- %
\subsection{Model order reduction via moment matching}
\label{lds:mm}

One way to construct a matrix $\bV$ such that \eqref{eq:tf-match} holds is by examining the concepts of moments and moment matching\cite{Antoulas2005}. Let the transfer function $\bfvarpi$ of $\bSigma$ be given by \eqref{eq:siso-tf}. Then the $\ell$th moment of $\bfvarpi$ around the point $s = s_\star$ is defined as the $\ell$th derivative of $\bfvarpi$ evaluated at $s_\star$, i.e.,
\begin{equation}
  \bfm_\ell(s_\star) := (-1)^\ell \left.\frac{d^\ell}{ds^\ell} \bfvarpi(s) \right|_{s=s_\star},
  \label{eq:moment}
\end{equation}
for $\ell \geq 0$. Consequently, since $\bfvarpi(s) = \bfc\T \left( \bH - s\bS \right)\inv \bfb$, the moments at $s_\star$ are
$$
  \bfm_\ell(s_\star) = \bfc\T \left( \bH - s_\star \bS \right)^{-(\ell+1)} \bfb, \qquad \ell > 0.
$$
Note also that the moments determine the coefficients of the Taylor series expansion of the transfer function $\bfvarpi$ in the neighborhood of $s_\star$
\begin{equation}
  \bfvarpi(s) = \bfm_0(s_\star) + \bfm_1(s_\star) \frac{s - s_\star}{1!} + \bfm_2(s_\star) \frac{(s - s_\star)^2}{2!} + \cdots
\end{equation}

Model order reduction via moment matching consists of constructing a subspace $\bV \inR[n][km]$ such that the original and reduced order model match moments
\begin{equation}
  \bfm_{i_j}(s_j) = \bfmh_{i_j}(s_j), \qquad j = 1,\ldots,k.
  \label{eq:mor-mm}
\end{equation}
If all moments to be matched are chosen at zero, i.e., $s_j = 0$ for $j = 1,2,\ldots,k$, the corresponding model is known as a Pad\'{e} approximation. In the general case, the problem \eqref{eq:mor-mm} is known as rational interpolation and can be solved by choosing the projection matrix $\bV$ such that
\begin{equation}
  \bV = \Span { \left( \bH - s_1\bS \right)\inv \bfb \quad
                   \left( \bH - s_2\bS \right)\inv \bfb \quad
                    \cdots \quad
                   \left( \bH - s_k\bS \right)\inv \bfb }.
  \label{eq:defV-app}
\end{equation}
It can be shown that the matrix $\bV$ defined in \eqref{eq:defV-app} spans a rational Krylov subspace and matches all the $0$th moments at $s_j$. For more information about the connections between moment matching and rational interpolation, we refer the interested reader to Section~11 of Antoulas' model order reduction book \cite{Antoulas2005}.

\section{Application of Model Order Reduction to the Linear Absorption 
  Cross Section}

\subsection{Computational results}
\label{sec:MORresults}

The proposed automatic MOR algorithm has been implemented in the Chronus
Quantum software package\cite{chronusq_beta} and in
MATLAB\footnote[4]{https://bitbucket.org/roelvb/mor4absspectrum}.
The following numerical experiments were performed using a single
Sandy--Bridge Intel Xeon compute node (E5-2650 v2 @ 2.60 GHz) with 16
cores and 512 GB DDR3 RAM. All of the water cluster test cases were performed
using the 6-31G(d) basis set without the use of molecular symmetry and
were chosen for their dense spectral character in the X-Ray spectral domain.
All of the geometries for the water clusters used in this work may be
found in the supplemental information.

The implementation of the MOR utilizes a synchronized approach to the
Generalized Minimum Residual (GMRES)\cite{Walker88_152} algorithm for the
solution of the linear systems. In this approach \cite{shak2016}, each linear
system is solved individually via the standard GMRES algorithm but its
matrix-vector products (GEMVs), which constitutes the dominant cost, are synchronized
and performed in batches. Hence, the GEMVs become matrix-matrix
products (GEMMs) and allow for optimal efficiency and cache utilization through
the use of Level 3 BLAS operations. In all experiments we used a block size of
12, coming from combining the 3 dipole vectors at 4 interpolation frequencies.

Several numerical experiments were performed to demonstrate the performance and accuracy of the proposed MOR algorithms. Since the interpolation points are merely used to construct a reduced order model, it is conceivable that we may choose them to be real numbers instead of complex numbers that contain a small imaginary damping factor.  The advantage of choosing real interpolation points is that all linear systems can be solved in real arithmetic. However, as we will see below, this approach may not lead to any performance gain and can even lead to a performance degradation.

We also examined how the order of the reduced order model changes as the damping factor $\eta$ changes and as the size of the molecular system increases as well as the overall computational scaling of the proposed method using the aforementioned water clusters. Numerical comparisons are made to the Lorentzian broadened poles of the propagator using the oscillator strengths \cite{Ball64_844,Harris69_3947,McKoy75_1168}. The eigenvalues and oscillator strengths were computed via BSEPACK\cite{bsepack,SJYDL2016} on a Cray XC40 with Haswell Intel Xeon compute nodes (E5-2698 v3 @2.3 GHz, 2x16 cores, 128 GB DDR4 RAM). The broadening factor was set equal to $\eta$ for comparison with the approximate MOR experiments.

% --- Real versus complex interpolation frequencies --- %
\subsubsection{Real versus complex interpolation frequencies}
\label{sec:MORresults-points}

We start with a cluster of 5 water molecules and are interested in computing
the absorption spectrum in the energy window $[540\,\eV,600\,\eV]$. The
dimension of the matrix $\mathbf{H}$ \cref{eq:defH} was $2n = 6$,500 and $\mathbf{H}$ had
394 eigenvalues in the energy window. The damping factor was $\eta = 1\,\eV$
and the tolerance for solving the linear systems was set to $10^{-6}$. The
damping factor was chosen to roughly \ch{encompass}{mimic} the effects of the core-hole
lifetime of the $K$-edge transitions in oxygen and vibrational
broadening\cite{Stohr_book}. \ins{It is important to note that the broadening due to
the damping parameter in these simulations is purely phenomenological, as no
vibronic effects are being explicitly treated.}

\begin{figure}[hbtp]
\fignames{fixed-}
\subfloat[\Cref{alg:mor}: real $\tau_j$]      {\plotfixed{2}{$k = 32$}}%
\subfloat[\Cref{alg:mor}: complex $\tau_j$]   {\plotfixed{3}{$k = 32$}}\\[10pt]
\subfloat[\Cref{alg:mor-MK}: real $\tau_j$]   {\plotfixed{4}{$k = 32$}}%
\subfloat[\Cref{alg:mor-MK}: complex $\tau_j$]{\plotfixed{5}{$k = 32$}}\\[10pt]
\caption{Numerical experiments for the evaluation of the XAS spectrum of 5 H$_2$O
clusters by the proposed MOR algorithms using a fixed model order ($k = 32$).
The MOR results are compared to the Lorentzian broadened poles of the
propagator, labelled Eigensystem. A damping parameter of $1\,\eV$ was chosen both
for the MOR calculations and the broadening factor of the Lorentzians for the
reference. It can be seen that the use of complex interpolation frequencies
for the construction of the model basis is important in spectrally dense
regions.}
\label{fig:fixed}
\end{figure}

In the first experiment, we used a fixed order $k = 32$ for the reduced order models and only changed the interpolation frequencies $\tau_j$, $j = 1,2,\ldots,k$. We computed the absorption spectrum by \cref{alg:mor,alg:mor-MK} for both real $\tau_j = \omega_j$ and complex $\tau_j = \omega_j + i\eta$, where $\omega_j$ were uniformly selected in the energy window. The corresponding results are presented in \cref{fig:fixed} and in the top part of \cref{tab:real-vs-complex}. Note that by using complex interpolation frequencies $\tau_j$, we obtained  good approximations to the absorption spectrum from both \cref{alg:mor,alg:mor-MK} even with such a small model size. On the other hand, the use of real $\tau_j$ resulted in poor approximations for both algorithms. This is due to the fact that the (real) interpolation frequencies are often very close to the (real) eigenvalues of $(\mathbf{H},\mathbf{S})$ or $\mathbf{M}\mathbf{K}$, resulting in ill-conditioned linear systems to be solved. However, this can be avoided with complex interpolation frequencies.

%%% TABLE %%%
\begin{table}[!b]
\caption{The effect of using real and complex interpolation frequencies $\tau_j$ on the MOR evaluation of XAS spectra for 5 H$_2$O clusters. Computational expense for \cref{alg:mor,alg:mor-MK}. Here $k$ is the reduced order, GEMMs is the total number of matrix-matrix products, and the total wall-clock time is given in seconds.%
\label{tab:real-vs-complex}}
\vspace{-0.5em}
\begin{center} \small
\begin{tabularx}{0.7\textwidth}{l|crc|crc|crc}
\toprule
\multicolumn{1}{c|}{Algorithm} &
 \multicolumn{3}{c|}{$k$} &
 \multicolumn{3}{c|}{GEMMs} &
 \multicolumn{3}{c}{Wall (s)} \\
\midrule
\Cref{alg:mor}: real $\tau_j$       &&  32 &&& 1,052 &&& 19.76 & \\
\Cref{alg:mor}: complex $\tau_j$    &&  32 &&& 776 &&& 40.97 & \\
\Cref{alg:mor-MK}: real $\tau_j$    &&  32 &&& 985 &&& 9.78 & \\
\Cref{alg:mor-MK}: complex $\tau_j$ &&  32 &&& 646 &&& 17.5 & \\
\midrule
\Cref{alg:mor}: real $\tau_j$       && 218 &&& 7,440 &&& 137.01 & \\
\Cref{alg:mor}: complex $\tau_j$    &&  87 &&& 2,285 &&& 115.50 & \\
\Cref{alg:mor-MK}: real $\tau_j$    && 211 &&& 6,541 &&& 65.31 & \\
\Cref{alg:mor-MK}: complex $\tau_j$ &&  87 &&& 2,026 &&& 52.70 & \\
\midrule
\multicolumn{4}{l|}{Conventional CPP (1,000 points)}          &&   18,126   &&&   538.90   & \\
\bottomrule
\end{tabularx}
\vspace{-1em}
\end{center}
\end{table}

Next, we repeated the previous experiment but chose the interpolation
frequencies via the adaptive refinement strategy introduced in
\cref{sec:mor}. As the error estimates, we used the difference of
the normalized absorption spectrum between two consecutive refinement
levels. The tolerance was set to $0.01$, which corresponds to a 1
percent change in the overall absorption spectrum on the window
$[540\,\eV,600\,\eV]$. This resulted in reduced order models of different
orders $k$, reported in the middle part of
\cref{tab:real-vs-complex}. We observe that in terms of the order
$k$, the use of complex interpolation frequencies has a significant advantage
over the use of real frequencies. Further, we also observe that the adaptive refinement strategy
for \cref{alg:mor,alg:mor-MK} resulted in very similar orders $k$ when the
same type of interpolation frequencies are used.

The corresponding computational expense for the previous two experiments is reported in \cref{tab:real-vs-complex} using various metrics. We observe that for both fixed and adaptive model orders, the computational cost required for \cref{alg:mor-MK} was significantly lower than that of \cref{alg:mor}. This is expected as both methods are mathematically equivalent and the former only deals with linear systems of half the dimension of the latter. Furthermore, although \emph{real} interpolation frequencies allow us to solve only \emph{real} linear systems, we observe that in case of adaptively chosen model orders, the drastic decrease in model order required for complex interpolation frequencies over real frequencies offsets this advantage. Finally, we note at the bottom of \cref{tab:real-vs-complex} that the use of \cref{alg:mor-MK} with complex interpolation frequencies reduces the computational expense by a factor of almost 10 compared to conventional complex polarization propagator calculations on a fine grid.

% --- Computational scaling --- %
\subsubsection{Computational scaling}
\label{sec:MORresults-scaling}

We now consider water clusters consisting of 5, 10, 15, 20, and 25 water molecules. The corresponding matrix dimensions are shown in \cref{tab:waters}. The energy window $[540\,\eV,600\,\eV]$ and damping factor $\eta = 1\,\eV$ were the same as for the previous experiments. We computed the absorption spectrum via \cref{alg:mor-MK} with complex interpolation frequencies chosen adaptively. The obtained absorption spectra are shown in \cref{fig:water}.

%%% FIGURE %%%
\begin{figure}[hbtp]
\centering
\figname{water_cluster_10H2O}%
\subfloat[Water cluster 10\,H$_2$O]{\plotspectrumos{water_cluster_10H2O_cq}{1}{$k = 82$}{10H2O}}
\figname{water_cluster_15H2O}%
\subfloat[Water cluster 15\,H$_2$O]{\plotspectrumos{water_cluster_15H2O_cq}{1}{$k = 82$}{15H2O}}\\[10pt]
\figname{water_cluster_20H2O}%
\subfloat[Water cluster 20\,H$_2$O]{\plotspectrumos{water_cluster_20H2O_cq}{1}{$k = 91$}{20H2O}}%
\figname{water_cluster_25H2O}%
\subfloat[Water cluster 25\,H$_2$O]{\plotspectrumos{water_cluster_25H2O_cq}{1}{$k = 94$}{25H2O}}\\[10pt]
\caption{Numerical experiments for the evaluation of the XAS spectrum of variably sized
H$_2$O clusters via \cref{alg:mor-MK} with adaptively chosen complex interpolation
frequencies. The MOR results are compared to the Lorentzian broadened poles of the
propagator, labelled Eigensystem. A damping parameter of $1\,\eV$ was chosen both
for the MOR calculations and the broadening factor of the Lorentzians for the
reference.}
\label{fig:water}
\end{figure}

%%% TABLE %%%
\begin{table}[hbtp]
\caption{Numerical experiments for the evaluation of the XAS spectrum of variably sized
H$_2$O clusters via \cref{alg:mor-MK} with adaptively chosen complex interpolation
frequencies. Here, $\mathbf{M}\mathbf{K}$ is of dimension $n$
with $\#\lambda$ eigenvalues lying within the energy window
$[540\,\eV,600\,\eV]$. The comparisons are made for GMRES convergence
tolerances of $10^{-4}$, $10^{-5}$, and $10^{-6}$, with $k$ as the reduced model order,
GEMMs as the total number of matrix-matrix products, and the total wall-clock time is given in
seconds.%
\label{tab:waters}}
\vspace{-0.5em}
\begin{center} \small
\begin{tabularx}{\textwidth}{rrr|rrr|rrr|rrr}
\toprule
\multicolumn{3}{c|}{Waters} &
 \multicolumn{3}{c|}{GMRES tol = $10^{-4}$} &
 \multicolumn{3}{c|}{GMRES tol = $10^{-5}$} &
 \multicolumn{3}{c}{GMRES tol = $10^{-6}$} \\[2pt]
\multicolumn{1}{c}{\#} &
 \multicolumn{1}{c}{$n$} &
 \multicolumn{1}{c|}{\#$\lambda$} &
 \multicolumn{3}{l|}{\ \,$k$ \hfill GEMMs \hfill Wall (s)} &
 \multicolumn{3}{l|}{\ \,$k$ \hfill GEMMs \hfill Wall (s)} &
 \multicolumn{3}{l}{\ \,$k$ \hfill GEMMs \hfill Wall (s)} \\
\midrule
 5 &  3,250 &   394 & \ 76 &   968 &     27.2 & \ 87 & 1,654 &     43.4 & \ 87 & 2,025 &     52.7 \\
10 & 13,000 & 1,456 &   99 & 1,749 &    636.2 &   83 & 2,404 &    867.1 &   82 & 3,235 &  1,157.0 \\
15 & 29,250 & 3,183 &   99 & 2,221 &  4,141.8 &   82 & 2,946 &  5,511.9 &   82 & 4,018 &  7,534.4 \\
20 & 52,000 & 5,524 &  123 & 2,742 & 14,665.8 &   89 & 3,317 & 17,807.0 &   91 & 4,594 & 25,656.5 \\
25 & 81,250 & 8,530 &  123 & 2,610 & 34,128.8 &   95 & 3,694 & 47,697.1 &   94 & 5,020 & 65,284.1 \\
\bottomrule
\end{tabularx}
\vspace{-1em}
\end{center}
\end{table}

The MOR results are given in \cref{tab:waters}, where we present the orders $k$ of the reduced order models, the total number of GEMMs, and the total wall-clock time for different GMRES convergence tolerances. Firstly, we observe that the order $k$ of the reduced order models increases sub-linearly with the number of waters, whereas the number of eigenvalues inside the energy window, \#$\lambda$, grows linearly with respect to the problem dimension. Secondly, the order $k$ decreases for increasing GMRES convergence tolerances. This is due to the fact that if we solve the linear systems less accurately, we match the moments less accurately and hence we need more interpolation points (a higher value of $k$) for the same accuracy of the reduced order model and the corresponding absorption spectra. Moreover, the order $k$ seems to stagnate around GMRES tolerance $10^{-5}$ and there were no visual differences any more between the obtained absorption spectra for GMRES tolerances $10^{-5}$ and $10^{-6}$.

%%% FIGURE %%%
\begin{figure}[hbtp]
\centering
\subfloat[Wall time]{%
\figname{water_clusters_walltime}%
\begin{tikzpicture}
\begin{loglogaxis}[%
 width=0.49\textwidth,%
 xlabel={$n$},%
 ylabel={Wall (s)},%
 xmin=1e3,xmax=1e5,%
 ymin=1e1,ymax=1e5,%
 legend pos=north west,%
]
\addplot[thick,mark=*,blue]         table[x index=1,y index=4]{\datfile{water_clusters}};
\addplot[thick,mark=square*,red]    table[x index=1,y index=7]{\datfile{water_clusters}};
\addplot[thick,mark=triangle*,cyan] table[x index=1,y index=10]{\datfile{water_clusters}};
\addplot[no marks,gray,densely dotted] plot coordinates { (1e3,1e1) (1e5,1e3) };
\addplot[no marks,gray,densely dashed] plot coordinates { (1e3,1e1) (1e5,1e5) };
\addplot[no marks,gray] plot coordinates { (1e3,1e1) (1e5,1e7) };
\legend{$10^{-4}$,$10^{-5}$,$10^{-6}$,$\cO(n)$,$\cO(n^2)$,$\cO(n^3)$};
\end{loglogaxis}
\end{tikzpicture}%
}\hfill%
\subfloat[Total number of GEMMs]{%
\figname{water_clusters_gemms}%
\begin{tikzpicture}
\begin{loglogaxis}[%
 width=0.49\textwidth,%
 xlabel={$n$},%
 ylabel={GEMMs},%
 xmin=1e3,xmax=1e5,%
 ymin=1e2,ymax=1e6,%
 legend pos=north west,%
]
\addplot[thick,mark=*,blue]         table[x index=1,y index=3]{\datfile{water_clusters}};
\addplot[thick,mark=square*,red]    table[x index=1,y index=6]{\datfile{water_clusters}};
\addplot[thick,mark=triangle*,cyan] table[x index=1,y index=9]{\datfile{water_clusters}};
\addplot[no marks,gray,densely dotted] plot coordinates { (1e3,1e3) (1e5,1e5) };
\addplot[no marks,gray,densely dashdotted] table[x index=0,y index=1]{\datfile{O_log10}};
\legend{$10^{-4}$,$10^{-5}$,$10^{-6}$,$\cO(n)$,$\cO(\log_{10}(n))$};
\end{loglogaxis}
\end{tikzpicture}%
}%
\caption{Cluster of H$_2$O molecules: MOR results for the absorption spectra computed via \cref{alg:mor-MK} with adaptively chosen complex interpolation frequencies. The comparisons are made for GMRES convergence tolerances of $10^{-4}$, $10^{-5}$, and $10^{-6}$.}
\label{fig:scaling}
\end{figure}

The total wall-clock time and number of GEMMs are also shown in \cref{fig:scaling}.
The left figure illustrates that the wall-clock time scales quadratically with
respect to the problem dimension, compared to a cubic scaling for a full
diagonalization. Moreover, the right figure shows that the number of GEMMs only
scales logarithmically, compared to an expected linear scaling for iterative
eigensolvers since the number of eigenvalues inside the energy window grows
linearly.
It is worth noting that the vector space dimension of the linear problem
also scales quadratically with system size.

% --- Effect of damping factor --- %
\subsubsection{Effect of damping factor}
\label{sec:MORbroad}

We examine the effect of the damping factor on the overall effectiveness of the proposed MOR algorithm in the low damping limit. We revisit the case of water clusters containing 5 water molecules from the previous subsections over the same energy widow. Specifically, we examine the effect on the damping parameter $\eta\in[0.1,1]\,\eV$ on the model order required to achieve a convergence of 1 percent in the absorption spectrum. The MOR results were obtains via \cref{alg:mor-MK} using adaptively chosen complex interpolation frequencies. The resulting spectra are presented in \cref{fig:damping}(a)--(c).

%%% FIGURE %%%
\begin{figure}[hbtp]
\centering
\figname{water_cluster_eta_0.5}%
\subfloat[$\eta = 0.5\ins{\,\eV}$]{\plotspectrumos{water_cluster_eta_0.5}{1}{$k = 104$}{eta_0.5}}
\figname{water_cluster_eta_0.3}%
\subfloat[$\eta = 0.3\ins{\,\eV}$]{\plotspectrumos{water_cluster_eta_0.3}{1}{$k = 157$}{eta_0.3}}\\[10pt]
\figname{water_cluster_eta_0.1}%
\subfloat[$\eta = 0.1\ins{\,\eV}$]{\plotspectrumos{water_cluster_eta_0.1}{1}{$k = 214$}{eta_0.1}}
\figname{water_clusters_damping}%
\subfloat[$k$ \ch{in}{as a} function of $\eta$]{\begin{tikzpicture}
\begin{axis}[%
 width=0.5\textwidth,%
 xlabel={damping factor $\eta$\ins{ (eV)}},%
 ylabel={reduced model order $k$},%
 xmin=0.1,xmax=1,%
 xtick={0.1,0.2,...,1},%
 ymin=0,ymax=250,%
 x dir=reverse,%
]
\addplot[thick,mark=*,blue] table[x index=0,y index=1]{\datfile{water_cluster_damping}};
\end{axis}
\end{tikzpicture}}\\[10pt]
\caption{Numerical experiments for the evaluation of the XAS spectrum of 5 H$_2$O clusters by \cref{alg:mor-MK} using different damping factors $\eta$. (a)--(c) The MOR results are compared to the Lorentzian broadened poles of the propagator, labelled Eigensystem. (d) Effect of the damping factor $\eta$ on the reduced model order $k$.}
\label{fig:damping}
\end{figure}

The effect of the damping factor on the automatically selected model order is illustrated in \cref{fig:damping}(d). In this figure, we observe that by decreasing the damping factor the reduced model order $k$ first remains almost constant until $0.5\,\eV$ and then slightly starts to increase for smaller values of $\eta$. Even in the low damping limit ($0.1\,\eV$), when the obtained absorption spectrum is exceptionally complicated and oscillatory relative to the previous experiments ($1\,\eV$), the required model order is still well within the realm of practicality for routine calculations. Thus the proposed MOR algorithm may be used as a general procedure which requires no assumption of (the smoothness of) the underlying absorption spectrum.

% ================ %
% == CONCLUSION == %
% ================ %
\subsection{Conclusion}
\label{sec:MORconclusion}
In this work, we have presented a novel, adaptive algorithm for the \emph{ab
initio} prediction of the absorption spectrum based on model order reduction
techniques applied to the quantum propagator. While this approach is general to
any spectral domain, the power of the proposed method is in those spectral
domains which are dense and interior in the propagator's eigenspectrum. The
accuracy and efficiency of this method to predict the X-Ray absorption spectrum
have been demonstrated using a series of water clusters. Water clusters were
chosen as an especially challenging case study as the propagator is spectrally
dense in the spectral neighborhood of the water's oxygen $K$-Edge. The
numerical experiments have shown that complex interpolation frequencies should
be preferred over real ones and that in this case the order of the reduced
order models only slightly increases with the problem dimension, in contrast to
the rapid growth of the number of eigenvalues inside the energy window.
Moreover, the wall-clock time for the proposed model order reduction algorithm scales
only quadratically with respect to the dimension of the problem,
compared to cubic scaling for eigenvalue based algorithms.
Further, it was shown that, even in the limit of highly oscillatory and low
damping absorption spectra, the proposed algorithm remains practical and thus
may be treated as agnostic to the underlying nature of the spectrum.
While results were presented only
for the TD-HF method, the proposed adaptive MOR algorithm is general to any
choice reference, propagator, or perturbation. Further, although it is not
expressly considered in this work, this technique is well suited for
parallelism on a massive scale as each of the linear system solutions is
completely independent from the other, thus allowing for minimal communication.
With the proposed MOR algorithm, routine study of X-Ray absorption spectra for
medium-to-large sized systems is simplified.

\section{Extraction of Property Dominant Eigenspaces from Model Basis}


